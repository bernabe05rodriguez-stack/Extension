var resolveSendMessageToNumber,rejectSendMessageToNumber,resolveSendMessageToGroup,resolveSendAttachmentsToNumber,resolveSendAttachmentsToGroup,campaignRunningIndex=null,stop=!1,pause=!1;function updateFreeTrialUsage(numSent){chrome.storage.local.get(["freeTrialExpiredUserData"],function(result){if(result.freeTrialExpiredUserData&&void 0!==result.freeTrialExpiredUserData.sent_count){let freeTrialExpiredUserData=result.freeTrialExpiredUserData,{sent_count}=freeTrialExpiredUserData;sent_count+=numSent,freeTrialExpiredUserData.sent_count=sent_count,chrome.storage.local.set({freeTrialExpiredUserData})}})}function getTimeGap(index,batch_size,time_gap,random_delay,batch_gap,custom_time_range=null){if(0==index)return 1;if(batch_size&&index%batch_size==0)return batch_gap;if(random_delay){if(custom_time_range&&custom_time_range.from&&custom_time_range.to)try{const fromValue=parseInt(custom_time_range.from),toValue=parseInt(custom_time_range.to);if(isNaN(fromValue)||isNaN(toValue)||fromValue>=toValue||fromValue<1||toValue>300||fromValue>300)return console.warn("Invalid custom range detected during campaign execution:",custom_time_range),console.warn("Falling back to default random range (3-10 seconds)"),getRandomNumber(3,10);const minAllowed=1,adjustedFrom=Math.max(fromValue,minAllowed);return getRandomNumber(adjustedFrom,Math.max(toValue,minAllowed))}catch(error){return console.error("Error processing custom time range during execution:",error),console.warn("Falling back to default random range due to error"),getRandomNumber(3,10)}return getRandomNumber(3,10)}return time_gap}function getRandomNumber(min,max){return Math.floor(Math.random()*(max-min+1))+min}function handleCustomRangeError(custom_time_range,messageIndex){if(console.warn(`Custom range validation failed at message ${messageIndex+1}:`,custom_time_range),custom_time_range){const fromValue=parseInt(custom_time_range.from),toValue=parseInt(custom_time_range.to);isNaN(fromValue)||isNaN(toValue)?console.warn("Custom range contains non-numeric values"):fromValue>=toValue?console.warn(`Invalid range: From (${fromValue}) >= To (${toValue})`):(fromValue<1||toValue>300)&&console.warn(`Range out of bounds: From=${fromValue}, To=${toValue}`)}return console.warn("Campaign will continue using default random range (3-10 seconds)"),null}async function messenger(numbers,message,time_gap,csv_data,customization,caption_customization,random_delay,batch_size,batch_gap,caption,send_attachment_first,campaign_type,index,paused_report_rows,paused_sent_count,attachmentsData=null,custom_time_range=null){trackSystemEvent("time_gap",time_gap),trackSystemEvent("batch_size",batch_size),trackSystemEvent("random_delay",random_delay),trackSystemEvent("batch_gap",batch_gap);let report_rows=initializeReport(campaign_type,paused_report_rows),sent_count=paused_sent_count||0,start_index=index||0,messages=customization?await setMessages(message,csv_data,"text",numbers.length):Array(numbers.length).fill(message),captions=isCaptionCustomisation(caption,csv_data)?await setCaptions(caption,csv_data):Array(numbers.length).fill(caption),attachments=attachmentsData||await getAttachmentsData(),campaign_data={numbers,message,caption,time_gap,random_delay,batch_size,batch_gap,csv_data,customization,caption_customization,send_attachment_first,campaign_type,custom_time_range};await saveCampaignState(0,!1,campaign_data,report_rows,sent_count);let{report_rows:finalReport,sent_count:finalCount,total_time}=await executeCampaign(numbers,messages,captions,attachments,start_index,report_rows,sent_count,campaign_data),curr_report={rows:finalReport,start_time:(new Date).getTime(),total_time,time_gap,campaign_type,sent_count:finalCount,custom_time_range};await updateDeliveryReports(numbers,message,curr_report,pause),updateFreeTrialUsage(numbers.length),campaignRunningIndex=null,chrome.runtime.sendMessage({type:"pro_send_notification",title:"Your messages are sent",message:"Open the extension to download the report"});var messanger_popup_div=document.getElementsByClassName("messanger_popup")[0];if(messanger_popup_div){messanger_popup_div.style.display="none";let rcount=parseInt(localStorage.getItem("rcount"))||0,rvisited=parseInt(localStorage.getItem("rvisited"))||0;rcount++,rcount>=3&&(rvisited||callIfNoOtherPopups(review_popup),rcount=0),localStorage.setItem("rcount",rcount)}attachments.length>0&&chrome.storage.local.get(["premiumUsageObject"],function(result){if(void 0!==result.premiumUsageObject){let updatedPremiumUsageObject={...result.premiumUsageObject,attachment:!0};attachments.length>1&&(updatedPremiumUsageObject={...updatedPremiumUsageObject,multipleAttachment:!0}),chrome.storage.local.set({premiumUsageObject:updatedPremiumUsageObject})}})}function handleAutodownloadCampaignReport(reports){chrome.storage.local.get(["autodownloadCampaignReport"],function(res){if(res.autodownloadCampaignReport){let last_report=reports[reports.length-1],reportDataURI=encodeURI(last_report.data),reportDownloadName=`${last_report.name||"Campaign "+reports.length} ${getReportDateFormat(last_report.date,!0)}.csv`,downloadLink=document.createElement("a");downloadLink.href=reportDataURI,downloadLink.download=reportDownloadName,downloadLink.click()}})}async function executeCampaign(numbers,messages,captions,attachments,start_index,report_rows,sent_count,campaign_data){let remaining_time,{time_gap,random_delay,batch_size,batch_gap,send_attachment_first,campaign_type,custom_time_range}=campaign_data,total_time=0,delays=[],total_numbers=numbers.length,total_numbers_to_sent=total_numbers-start_index,not_sent_message_count=0,not_sent_attachments_count=0;for(let i=0;i<numbers.length;i++){let curr_time_gap;try{if(0==i)curr_time_gap=1;else if(batch_size&&i%batch_size==0)curr_time_gap=batch_gap;else if(random_delay&&custom_time_range){const fromValue=parseInt(custom_time_range.from),toValue=parseInt(custom_time_range.to);isNaN(fromValue)||isNaN(toValue)||fromValue>=toValue||fromValue<1||toValue>300?(console.warn("Invalid custom range detected during time estimation, using default random average"),curr_time_gap=6.5):curr_time_gap=Math.floor((fromValue+toValue)/2)}else curr_time_gap=random_delay?6.5:time_gap;(isNaN(curr_time_gap)||curr_time_gap<1)&&(console.warn(`Invalid time gap for estimation: ${curr_time_gap}, using default`),curr_time_gap=random_delay?6.5:time_gap||3)}catch(error){console.error("Error calculating time gap for estimation:",error),curr_time_gap=random_delay?6.5:time_gap||3}total_time+=curr_time_gap,delays.push(curr_time_gap)}remaining_time=total_time,messanger_popup(),checkTipsInterval();for(let i=start_index;i<total_numbers;i++){if(triggerEscape(),campaignRunningIndex=i,stop){stop=!1;break}if(pause){await saveCampaignState(i,!0,campaign_data,report_rows,sent_count),pause=!1;break}let actual_time_gap,curr_number=campaign_type.includes("number")?numbers[i].replace(/\D/g,""):"",curr_group_id=campaign_type.includes("group")?numbers[i]:"",curr_message=messages.length>=i?messages[i]:"",curr_caption=captions.length>=i?captions[i]:"";try{if(random_delay&&custom_time_range){const fromValue=parseInt(custom_time_range.from),toValue=parseInt(custom_time_range.to);(isNaN(fromValue)||isNaN(toValue)||fromValue>=toValue||fromValue<1||toValue>300)&&(custom_time_range=handleCustomRangeError(custom_time_range,i),campaign_data.custom_time_range=custom_time_range)}actual_time_gap=getTimeGap(i,batch_size,time_gap,random_delay,batch_gap,custom_time_range),(isNaN(actual_time_gap)||actual_time_gap<1)&&(console.warn(`Invalid time gap calculated: ${actual_time_gap}, using default value`),actual_time_gap=random_delay?getRandomNumber(3,10):time_gap||3)}catch(error){console.error("Error calculating time gap during campaign execution:",error),actual_time_gap=random_delay?getRandomNumber(3,10):time_gap||3,console.warn(`Using fallback time gap: ${actual_time_gap} seconds`)}let curr_delay=1e3*Math.max(1,actual_time_gap-1),sending_to=campaign_type.includes("group")?groupIdToName[curr_group_id]:curr_number;remaining_time-=delays[i],await updateMessengerProgressBar(sending_to,i,total_numbers,remaining_time,total_time),await delay(curr_delay);let open_chat_with_msg=RUNTIME_CONFIG.useOldMessageSending?curr_message:"",is_chat_opened=!curr_number||await openNumber(curr_number,open_chat_with_msg);if(is_chat_opened)if(send_attachment_first)var{is_attachments_sent,comments:attachments_comments,error:attachments_error}=await handleAttachmentsSend(curr_number,curr_group_id,attachments,curr_caption,"-",!0),{is_message_sent,comments:message_comments,error:message_error}=await handleMessageSend(curr_number,curr_group_id,curr_message);else var{is_message_sent,comments:message_comments,error:message_error}=await handleMessageSend(curr_number,curr_group_id,curr_message),{is_attachments_sent,comments:attachments_comments,error:attachments_error}=await handleAttachmentsSend(curr_number,curr_group_id,attachments,curr_caption,is_message_sent);else var is_message_sent=curr_message?"NO":"-",is_attachments_sent=attachments&&attachments.length>0?"NO":"-",message_comments="Invalid Number; Tip: Please ensure that your number exists on WhatsApp!",attachments_comments="";let final_comments=[message_comments,attachments_comments].filter(comment=>comment.length>0).join(" ; ");0==final_comments.length&&(final_comments="-",sent_count++);let final_error=[message_error?String(message_error):"",attachments_error?String(attachments_error):""].filter(err=>err.length>0).join(" ; ");0==final_error.length&&(final_error="-"),report_rows.push([sending_to,is_message_sent,is_attachments_sent,final_comments,final_error]),"-"!=is_message_sent&&(0==message_comments.length?trackSystemEvent("send_message_success_total"):is_chat_opened&&(not_sent_message_count++,trackSystemEvent("send_message_failed_total",message_comments))),"-"!=is_attachments_sent&&(0==attachments_comments.length?trackSystemEvent("send_attachments_success_total"):is_chat_opened&&(not_sent_attachments_count++,trackSystemEvent("send_attachments_failed_total",attachments_comments)))}return messages.length>0&&messages[0].length>0&&(0==not_sent_message_count&&trackSystemEvent("send_message_complete_success"),not_sent_message_count==total_numbers_to_sent&&trackSystemEvent("send_message_complete_failed")),attachments&&attachments.length>0&&(0==not_sent_attachments_count&&trackSystemEvent("send_attachments_complete_success"),not_sent_attachments_count==total_numbers_to_sent&&trackSystemEvent("send_attachments_complete_failed")),clearInterval(tipsIntervalID),{report_rows,sent_count,total_time}}async function handleMessageSend(number,group_id,message){return message?number?RUNTIME_CONFIG.useOldMessageSending?await sendMessageToNumber(number,message):await sendMessageToNumberNew(number,message):group_id?await sendMessageToGroup(group_id,message):void 0:{is_message_sent:"-",comments:""}}async function sendMessageToNumber(number,message){try{return new Promise((resolve,reject)=>{setTimeout(()=>{let send_message_btn=getDocumentElement("send_message_btn");send_message_btn?(send_message_btn.click(),trackSuccess("send_message_to_number_success"),resolve({is_message_sent:"YES",comments:""})):resolve({is_message_sent:"NO",comments:"Issue with the number",error:"Send button is not found"})},1e3)})}catch(e){return console.error("ERROR :: sendMessageToNumber :: "+e),trackError("send_message_to_number_error",e),{is_message_sent:"NO",comments:"Error while sending message to number",error:e}}}async function sendMessageToNumberNew(number,message){try{let curr_chat_number=getCurrentChatNumber();if(number=curr_chat_number||number,await isUniqueIdentifierEnabled()){const modified=appendUniqueIdentifier(message,null);message=modified.message}return new Promise((resolve,reject)=>{resolveSendMessageToNumber=resolve,rejectSendMessageToNumber=async payload=>{pasteMessage(message),resolve(await sendMessageToNumber())},window.dispatchEvent(new CustomEvent("PROS::send-message",{detail:{number,message}}))})}catch(e){return console.error("ERROR :: sendMessageToNumber :: "+e),trackError("send_message_to_number_new_error",e),{is_message_sent:"NO",comments:"Error while sending message to number",error:e}}}async function sendMessageToGroup(group_id,message){try{if(await isUniqueIdentifierEnabled()){const modified=appendUniqueIdentifier(message,null);message=modified.message}return new Promise((resolve,reject)=>{resolveSendMessageToGroup=resolve,window.dispatchEvent(new CustomEvent("PROS::send-message-to-group",{detail:{group_id,message}}))})}catch(e){return console.error("ERROR :: sendMessageToGroup :: "+e),trackError("send_message_to_group_error",e),{is_message_sent:"NO",comments:"Error while sending the message to group",error:e}}}async function handleAttachmentsSend(number,group_id,attachments,caption,is_message_sent,wait_till_send=!1){return"NO"===is_message_sent?{is_attachments_sent:"NO",comments:""}:attachments&&attachments.length>0?number?await sendAttachmentsToNumber(number,attachments,caption,wait_till_send):group_id?await sendAttachmentsToGroup(group_id,attachments,caption,wait_till_send):void 0:{is_attachments_sent:"-",comments:""}}async function sendAttachmentsToNumber(number,attachments,caption,wait_till_send){try{let curr_chat_number=getCurrentChatNumber();if(number=curr_chat_number||number,await isUniqueIdentifierEnabled())if(Array.isArray(caption))caption=caption.map(cap=>{if(cap&&cap.trim()){return appendUniqueIdentifier(null,cap).caption}return cap});else if(caption){const modified=appendUniqueIdentifier(null,caption);caption=modified.caption}return new Promise((resolve,reject)=>{resolveSendAttachmentsToNumber=resolve,window.dispatchEvent(new CustomEvent("PROS::send-attachments",{detail:{number,attachments,caption,waitTillSend:wait_till_send}}))})}catch(e){return console.error("ERROR :: sendAttachmentsToNumber :: "+e),trackError("send_attachments_to_number_error",e),{is_attachments_sent:"NO",comments:"Error while sending the attachments to number",error:e}}}async function sendAttachmentsToGroup(group_id,attachments,caption,wait_till_send){try{if(await isUniqueIdentifierEnabled())if(Array.isArray(caption))caption=caption.map(cap=>{if(cap&&cap.trim()){return appendUniqueIdentifier(null,cap).caption}return cap});else if(caption){const modified=appendUniqueIdentifier(null,caption);caption=modified.caption}return await new Promise((resolve,reject)=>{resolveSendAttachmentsToGroup=resolve,window.dispatchEvent(new CustomEvent("PROS::send-attachments-to-group",{detail:{attachments,caption,groupId:group_id,waitTillSend:wait_till_send}}))})}catch(e){return console.error("ERROR :: sendAttachmentsToGroup :: "+e),trackError("send_attachments_to_group_error",e),{is_attachments_sent:"NO",comments:"Error while sending the attachments to group",error:e}}}async function openNumber(number,message="",time_gap=1){try{await openNumberTab(number,message);const has_opened=await hasChatOpened();if(has_opened)await delay(1e3*time_gap);else{const invalid_chat_ok_btn=getDocumentElement("invalid_popup_ok_btn");invalid_chat_ok_btn&&(invalid_chat_ok_btn.click(),document.querySelector(".invalid_number_error").style.display="grid",document.querySelector(".currently_sending_number").style.color="#D13B3B",await delay(3e3))}return has_opened}catch(e){return console.error("ERROR :: openNumber :: ",e),trackError("open_number_error",e),!1}}async function openNumberTab(number,message){const encodedMessage=message?encodeURIComponent(message):"",link=`https://api.whatsapp.com/send?phone=${number}${encodedMessage?`&text=${encodedMessage}`:""}`;let linkElement=document.getElementById("whatsapp-message-sender");linkElement||(linkElement=document.createElement("a"),linkElement.id="whatsapp-message-sender",document.body.append(linkElement)),linkElement.setAttribute("href",link),linkElement.click()}async function hasChatOpened(){return new Promise((resolve,reject)=>{let is_chat_loading=!1,wait_time_ms=0,checkChatOpenedInterval=setInterval(()=>{wait_time_ms+=100;const starting_chat_popup=getDocumentElement("starting_chat_popup"),invalid_chat_popup=getDocumentElement("invalid_chat_popup");(starting_chat_popup||wait_time_ms>=500)&&(is_chat_loading=!0),is_chat_loading&&(invalid_chat_popup||wait_time_ms>=1e4?(clearInterval(checkChatOpenedInterval),resolve(!1)):starting_chat_popup||(clearInterval(checkChatOpenedInterval),resolve(!0)))},100)})}function getCurrentChatNumber(){try{let conversation_message_div=getDocumentElement("conversation_message_div"),number=null;if(conversation_message_div){let curr_chat_number=conversation_message_div.dataset.id.split("_")[1].split("@c.us")[0];curr_chat_number.length>10&&(number=curr_chat_number)}return number}catch(e){return console.error("ERROR :: getCurrentChatNumber :: "+e),null}}function stopCampaign(){isPremiumFeatureAvailable()?(stop=!0,trackButtonClick("stop_campaign_premium"),cancelDelay()):premium_reminder("stop_campaign","Premium"),chrome.storage.local.get(["premiumUsageObject"],function(result){if(void 0!==result.premiumUsageObject){let updatedPremiumUsageObject={...result.premiumUsageObject,stop:!0};chrome.storage.local.set({premiumUsageObject:updatedPremiumUsageObject})}}),trackButtonClick("stop_campaign")}function pauseCampaign(){isAdvanceFeatureAvailable()?(pause=!0,trackButtonClick("pause_campaign_premium"),cancelDelay()):premium_reminder("pause_campaign","Advance"),trackButtonClick("pause_campaign")}function isCaptionCustomisation(caption,csv_data){if(0==csv_data.length)return!1;const pattern=/\{\{([^}]+)\}\}/g,matches=[];let match;for(;null!==(match=pattern.exec(caption));)matches.push(match[1].trim());for(var j=0;j<csv_data[0].length;j++){if(hasLeadingOrTrailingSpaces(csv_data[0][j]))variable=csv_data[0][j].trim();else var variable=csv_data[0][j];if(matches.includes(variable))return!0}return!1}async function setCaptions(caption,csv_data){let customisedCaption,captionArr=caption,customisedArr=[];for(let i=0;i<captionArr.length;i++)customisedCaption=await setMessages([captionArr[i]],csv_data,"caption"),customisedArr.push(customisedCaption);return finalArr=transposeArray(customisedArr),finalArr}async function setMessages(message,csv_data,purpose,numbers_length){if("text"==purpose&&0==csv_data.length){let return_message=[];for(let i=0;i<numbers_length;i++)return_message.push(message);return return_message}for(var messages=[],i=1;i<csv_data.length;i++){if("caption"==purpose)var temp_message=message[0];else temp_message=message;for(var j=0;j<csv_data[0].length;j++){if(hasLeadingOrTrailingSpaces(csv_data[0][j]))variable=csv_data[0][j].trim();else var variable=csv_data[0][j];var curr_text=csv_data[i][j];temp_message.includes("{{"+variable+"}}")&&(temp_message=temp_message.replaceAll("{{"+variable+"}}",curr_text))}messages.push(temp_message)}return messages}async function messanger_popup(){var messanger_popup_div=document.getElementsByClassName("messanger_popup")[0];if(messanger_popup_div)messanger_popup_div.style.display="block";else{var popup=document.createElement("div");popup.className="messanger_popup";var sendingMessageDiv=document.createElement("div");sendingMessageDiv.className="message_being_sent";var campaignDiv=document.createElement("div");campaignDiv.className="did_you_know";var campaignHelpLogo=document.createElement("img");campaignHelpLogo.className="campaign_help_logo",campaignHelpLogo.src=pro_help_icon_src,campaignDiv.appendChild(campaignHelpLogo);var modal_content=document.createElement("div");modal_content.className="messanger_popup_content",sendingMessageDiv.appendChild(modal_content),modal_content.appendChild($($.parseHTML(`<div class="popup_text_title"><img style="width: 25px; height: 25px;" src=${pro_email_icon_src}></img><p id="message_sending_popup_title" style="margin-left: 15px; font-weight: 700; font-size: 16px; line-height: 20.7px; align-items: center; ">Your messages are being sent</p></div>`))[0]),modal_content.appendChild($($.parseHTML('<div class="messanger_time_bar_outline"><div class="messanger_time_bar" ></div></div>'))[0]),modal_content.appendChild($($.parseHTML('<div class="messanger_sending"></div>'))[0]);let campaignButtons=document.createElement("div");if(campaignButtons.className="campaign_buttons",campaignButtons.innerHTML=`\n            <div class="pause_campaign_button CtaBtn">\n                <div class="pause_campaign_image">\n                    <img src=${pro_pause_icon_src} alt="" />\n                </div>\n                <p class="text">Pause Campaign</p>\n            </div>\n            <div class="stop_campaign_button CtaBtn">\n                <div class="circle"></div><p class="text">Stop Campaign</p>\n            </div>\n        `,modal_content.appendChild(campaignButtons),!isPremiumFeatureAvailable()){let{name:country_name,name_code:country_code,currency:country_currency}=location_info;country_name=Object.keys(COUNTRY_WITH_SPECIFIC_PRICING).includes(country_code)?COUNTRY_WITH_SPECIFIC_PRICING[country_code]:"international";let pricingButtonLink="";chrome.storage.local.get(["my_number"]);("Basic"==last_plan_type||"Advance"==last_plan_type)&&(pricing_link="");let timeGapReminderDiv=document.createElement("div");timeGapReminderDiv.className="time_gap_reminder_div",timeGapReminderDiv.innerHTML=`<div class="circle">30</div><p class="text" id="time_gap_reminder_text">Time Gap between messages is 30 sec. Purchase <a href="${pricingButtonLink}" target="_blank" class="styled_text"> Premium </a> to reduce time gap between messages.</p>`,modal_content.appendChild(timeGapReminderDiv)}popup.appendChild(sendingMessageDiv),popup.appendChild(campaignDiv),document.querySelector("body").appendChild(popup),modal_content.appendChild($($.parseHTML('<span id="close_edit1" style="position: absolute;top: 12px;right: 12px;font-size: 20px;width:14px"><img class="CtaCloseBtn" src="'+pro_close_img_src+'" style="width: 100%;" alt="x"></span>'))[0]),document.getElementById("close_edit1").addEventListener("click",function(event){document.getElementsByClassName("messanger_popup")[0].style.display="none"}),document.querySelector(".stop_campaign_button").addEventListener("click",stopCampaign),document.querySelector(".pause_campaign_button")?.addEventListener("click",pauseCampaign),loadTips()}document.getElementById("message_sending_popup_title").innerText=await translate("Your messages are being sent")}async function updateMessengerProgressBar(sending_to,index,total_numbers,remaining_time,total_time){let messanger_sending=document.getElementsByClassName("messanger_sending")[0];if(messanger_sending){messanger_sending.innerHTML="";let currently_sending_to_html=`<div style="margin: auto;display: flex; width: 100%; align-items: center; justify-content: center; font-weight: 400; font-size: 12px; line-height: 15.53px">Currently sending to :  <strong style="padding: 0px 12px;" class="currently_sending_number">${sending_to}</strong>  ( ${index+1} of ${total_numbers} )</div>`,invalid_number_error_html=`<div class="invalid_number_error" style="display: none;"><img src=${pro_error_icon_src} style="width: 17px; height: 17px"/><p class="text"><span style="font-weight: 700;">Invalid number</span> : <span>${await translate("Please check the delivery report after the campaign ends.")}</span></p></div>`;messanger_sending.appendChild($($.parseHTML(currently_sending_to_html))[0]),messanger_sending.appendChild($($.parseHTML(invalid_number_error_html))[0])}let messanger_time_bar=document.getElementsByClassName("messanger_time_bar")[0];if(messanger_time_bar){messanger_time_bar.innerHTML="";let remaining_bar=0==index?0:100*(1-remaining_time/total_time),hours=Math.floor(remaining_time/3600),mins=Math.ceil(remaining_time/60)%60,remaining_time_text_html=`<div style="width: 400px;color: #fff;position: absolute;text-align: center;font-weight: normal;font-size: 12px;padding: 4px;">${"Approx. "+(hours>0?hours+(hours>1?" hours ":" hour "):"")+mins+(mins>1?" minutes ":" minute ")+"remaining"}</div>`,remaining_time_bar_html=`<div style="width: ${remaining_bar}%;background: #357A71;height: 100%;border-radius: 16px;"></div>`;messanger_time_bar.appendChild($($.parseHTML(remaining_time_text_html))[0]),messanger_time_bar.appendChild($($.parseHTML(remaining_time_bar_html))[0])}}function loadTips(){chrome.storage.local.get(["ptc852"],async res=>{let ptc852=res.ptc852,tip_title=await translate("Did you know?"),tip_content=await translate(DID_YOU_KNOW_TIPS[ptc852]),msgNew=document.createElement("div");msgNew.style.color="#fff",msgNew.innerHTML=`<strong class='did_you_know_text' style='color: #fff;'>${tip_title}</strong><span>${tip_content}</span>`,msgNew.className="messanger_popup_tips",document.querySelector(".did_you_know").appendChild(msgNew)})}window.addEventListener("beforeunload",function(e){try{if(chrome.storage.local.get(["scheduled_campaigns"],async function(result){let scheduled_campaigns=result.scheduled_campaigns||[];for(let i=0;i<scheduled_campaigns.length;i++)scheduled_campaigns[i].hasBeenScheduled=!1;chrome.storage.local.set({scheduled_campaigns})}),null!==campaignRunningIndex){let obj={isCampaignRunning:!0,index:campaignRunningIndex};chrome.storage.local.set({resumeCampaign:obj})}}catch(e){console.error("Error :: onEvent :: beforeunload :: ",e)}});let tipsIntervalID="";function checkTipsInterval(){clearInterval(tipsIntervalID),""==tipsIntervalID&&updateTipsCount()}function updateTipsCount(){tipsIntervalID=setInterval(()=>{chrome.storage.local.get(["ptc852"],async response=>{let ptc852=(response.ptc852+1)%6,messanger_display=document.querySelector(".messanger_popup");if(messanger_display&&"none"!=messanger_display.style.display){let tip_title=await translate("Did you know?"),tip_content=await translate(DID_YOU_KNOW_TIPS[ptc852]);document.querySelector(".messanger_popup_tips").innerHTML=`<strong class='did_you_know_text' style='color: #fff;'>${tip_title}</strong><span>${tip_content}</span>`,chrome.storage.local.set({ptc852})}})},15e3)}async function updateDeliveryReports(numbers,message,curr_report,pause){let[reports,campaigns,templates]=await new Promise(resolve=>{chrome.storage.local.get(["deliveryReports","campaigns","templates"],res=>{let reports=res.deliveryReports||[],campaigns=res.campaigns||[],templates=res.templates||[];resolve([reports,campaigns,templates])})});reports.length>=10&&reports.shift(1);let[campaign_name,template_name]=await new Promise(resolve=>{let campName=null,tempName=null,numbers_str=numbers.join(",");campaigns.forEach(campaign=>{campaign.numbers==numbers_str&&(campName=campaign.name)}),templates.forEach(template=>{template.message==message&&(tempName=template.name)}),resolve([campName,tempName])}),{rows,start_time,campaign_type,sent_count,total_time,time_gap,custom_time_range}=curr_report;const is_custom_range=custom_time_range&&custom_time_range.from&&custom_time_range.to;let{msg_for_popup,msg_for_report:time_saved_msg,time_saved}=calc_time_saved(numbers.length,time_gap,is_custom_range),report_side_info=[["Last Run",new Date(start_time).toLocaleString("en-IN").replace(","," ").toLocaleUpperCase()],["Campaign Name",campaign_name||"Campaign "+(reports.length+1)],["Campaign Type",campaign_type],["Template Name",template_name||"-"],["Overall Report",`${sent_count} sent out of ${numbers.length}`],[time_saved_msg,time_saved]],empty_cols=Array(rows[0].length).fill(""),report_length=rows.length;for(let i=0;i<report_side_info.length;i++){let side_info_arr=["","",...report_side_info[i]];i<report_length?rows[i].push(...side_info_arr):rows.push([...empty_cols,...side_info_arr])}let csv_data="data:text/csv;charset=utf-8,"+rows.map(e=>e.join(",")).join("\n");reports.push({name:campaign_name,date:start_time,data:csv_data}),await chrome.storage.local.set({deliveryReports:reports}),handleAutodownloadCampaignReport(reports),campaign_end_popup(reports,sent_count,numbers.length,total_time,time_gap,pause,custom_time_range)}async function campaign_end_popup(reports,sent_count,total_numbers,total_time_taken,time_gap,isPaused,custom_time_range){total_time_taken=Math.ceil(total_time_taken/60);let last_report=reports[reports.length-1];const is_custom_range=custom_time_range&&custom_time_range.from&&custom_time_range.to;let{msg_for_popup,msg_for_report,time_saved}=calc_time_saved(total_numbers,time_gap,is_custom_range),reportDataURI=encodeURI(last_report.data),reportDownloadDate=getReportDateFormat(last_report.date,!0),reportDownloadName=`${last_report.name||"Campaign "+reports.length} ${reportDownloadDate}.csv`;const messageSentDiv=`\n    <div class='message_send_div'>\n        <div class='message_send_text' style='color: #fff'>\n            <img style='width: 50px; height: 50px' src=${pro_read_icon_src}></img>\n            <p style='font-weight: 700; font-size: 20px; line-height: 25.88px'>\n                ${await translate("Your campaign is completed")}\n            </p>\n        </div>\n        <span id="report_download_edit" style="position: absolute;top: 12px;right: 12px;font-size: 20px;width:14px; z-index: 1000"><img class="CtaCloseBtn" src=${pro_close_img_src} style="width: 100%;" alt="x"></span>\n    </div>\n    <div class='campaign_info_div'>\n        <div style='display: flex; margin: 0 auto'>\n            <div class='campaign_info'>\n                <div class='campaign_info_text'>\n                    <p><span class='campaign_name'>Campaign ${reports.length}</span> : Sent to <span class='numbers_message_sent_to num_of_numbers'>${sent_count}</span> numbers out of   <span class='total_numbers num_of_numbers'>${total_numbers}</span></p>\n                    <p>${await translate("Approximate time taken")} : <span class='approx_time num_of_numbers'>${total_time_taken}</span> ${total_time_taken>1?"minutes":"minute"}</p>\n                </div>\n                <div class='download_campaign_report'>\n                    <p>${await translate("Check our new delivery report")} :  </p>\n                    <a class='download_report_button CtaBtn' href=${reportDataURI} download="${reportDownloadName}">\n                        Download Delivery Report\n                    </a>\n                </div>\n            </div>\n            <div class='time_saved_div'>\n                <div class='time_saved_circle'>\n                    <p class='time_saved'>${time_saved}</p>\n                    <p class='time_saved_text' style='text-align: center'>\n                        ${await translate(msg_for_popup)}\n                    </p>\n                </div>\n            </div>\n        </div>\n    </div>\n    `,popup=document.createElement("div");popup.className="campaign-end trial_popup",popup.innerHTML=messageSentDiv,document.body.appendChild(popup),document.querySelector(".download_report_button").addEventListener("click",()=>{trackButtonClick("download_delivery_report_campaign_end")});document.getElementById("report_download_edit").addEventListener("click",()=>{document.querySelector(".campaign-end").remove(),trackCloseButtonClick("campaign_end_popup_close")}),chrome.storage.local.get(["campaignNumber"],function(res){null!=res.campaignNumber&&null!=res.campaignNumber&&res.campaignNumber?chrome.storage.local.set({campaignNumber:res.campaignNumber+1}):chrome.storage.local.set({campaignNumber:1})}),isPaused&&(reports.pop(),chrome.storage.local.set({deliveryReports:reports})),trackButtonView("campaign_end_popup")}function getReportDateFormat(date_ms,isDownloadName=!1){const today=new Date,reportDate=new Date(date_ms),diffDays=Math.round(Math.abs((today-reportDate)/864e5)),reportDay=reportDate.getDate(),dayString=reportDay+getDaySuffix(reportDay);let reportDateString,reportTimeString=reportDate.toLocaleTimeString("en-US",{hour:"numeric",minute:"numeric"});return isDownloadName||diffDays>1?reportDateString=`${dayString} ${reportDate.toLocaleDateString("en-US",{month:"short"})}`:0===diffDays?reportDateString="Today":1===diffDays&&(reportDateString="Yesterday"),isDownloadName?`(Last Run at ${reportDateString} ${reportTimeString})`:`(Last Run: ${reportDateString} ${reportTimeString})`}function calc_time_saved(total_numbers,time_gap,is_custom_range=!1){let msg_for_popup,msg_for_report,diff;isPremiumFeatureAvailable()?time_gap>=30?(msg_for_popup=is_custom_range?"could have been saved with custom range":"could have been saved",msg_for_report=is_custom_range?"Time that could have been saved with custom range":"Time that could have been saved",diff=(time_gap-1)*total_numbers):(msg_for_popup=is_custom_range?"saved with custom range":"saved with premium",msg_for_report=is_custom_range?"Time saved with custom range":"Time saved with premium",diff=(30-time_gap)*total_numbers):(msg_for_popup="could have been saved with premium",msg_for_report="Time that could have been saved with premium",diff=29*total_numbers);let hours=Math.floor(diff/3600),minutes=Math.floor(diff/60-60*hours),seconds=diff-3600*hours-60*minutes,time_saved="";return hours&&minutes?time_saved=`${hours} hrs ${minutes} min`:(hours&&(time_saved+=`${hours} hrs `),minutes&&(time_saved+=`${minutes} min `),seconds&&(time_saved+=`${seconds} sec`)),{msg_for_popup,msg_for_report,time_saved}}async function handleScheduleCampaigns(){chrome.storage.local.get(["scheduled_campaigns"],async function(result){let scheduled_campaigns=result.scheduled_campaigns||[];for(let i=0;i<scheduled_campaigns.length;i++){let isScheduledWithin24Hours=!1;if(isScheduledWithin24Hours=isWithin24Hours(scheduled_campaigns[i].schedule_date,scheduled_campaigns[i].schedule_time),1==scheduled_campaigns[i].hasBeenScheduled||!isScheduledWithin24Hours)continue;let{numbers,groups,message,time_gap,csv_data,customization,schedule_time,random_delay,batch_size,batch_gap,caption,send_attachment_first,caption_customization,attachmentsData,custom_time_range}=scheduled_campaigns[i];const timeOutId=await schedule_message(numbers,groups,message,time_gap,csv_data,customization,caption_customization,schedule_time,random_delay,batch_size,batch_gap,caption,send_attachment_first,attachmentsData,custom_time_range);scheduled_campaigns[i].hasBeenScheduled=!0,scheduled_campaigns[i].timeOutId=timeOutId}chrome.storage.local.set({scheduled_campaigns})})}async function schedule_message(numbers,groups,message,time_gap,csv_data,customization,caption_customization,schedule_time,random_delay,batch_size,batch_gap,caption,send_attachment_first,attachmentsData,custom_time_range=null){var stime=schedule_time.split(":"),time12=(stime[0]%12).toString()+":"+stime[1]+(stime[0]<12?"AM":"PM");chrome.runtime.sendMessage({type:"pro_send_notification",title:"Your campaign has been scheduled for "+time12,message:"Open the extension to view all scheduled campaigns."});var ctime=new Date,interval_time=(60*(Number(stime[0])-ctime.getHours())+(Number(stime[1])-ctime.getMinutes())+1440)%1440;return setTimeout(()=>{chrome.storage.local.get(["scheduled_campaigns"],async function(result){let scheduled_campaigns=result.scheduled_campaigns||[];scheduled_campaigns.length>0&&scheduled_campaigns.shift(),chrome.storage.local.set({scheduled_campaigns})}),null==numbers||null==numbers||0==numbers.length?messenger(groups,message,time_gap,csv_data,customization,caption_customization,random_delay,batch_size,batch_gap,caption,send_attachment_first,"Scheduled_group",null,null,null,attachmentsData,custom_time_range):messenger(numbers,message,time_gap,csv_data,customization,caption_customization,random_delay,batch_size,batch_gap,caption,send_attachment_first,"Scheduled_number",null,null,null,attachmentsData,custom_time_range)},6e4*interval_time)}function initializeReport(campaign_type,paused_report_rows){let report_header=campaign_type.includes("group")?["Group Name","Text Delivered?","All Attachments Delivered?","Comments","Error"]:["Phone Number","Text Delivered?","All Attachments Delivered?","Comments","Error"];return paused_report_rows||[report_header]}function getTimeGap(index,batch_size,time_gap,random_delay,batch_gap,custom_range=null){return 0==index?1:batch_size&&index%batch_size==0?batch_gap:random_delay?custom_range&&custom_range.from&&custom_range.to?getRandomNumber(custom_range.from,custom_range.to):getRandomNumber(3,10):time_gap}async function getAttachmentsData(){return new Promise(resolve=>{chrome.storage.local.get(["attachmentsData"],res=>{resolve(res.attachmentsData||[])})})}async function saveCampaignState(index,paused,campaign_data,report_rows,sent_count){const pausedCampaignData={paused,index,campaignData:campaign_data,attachmentsData:await getAttachmentsData(),report_rows,send_count:sent_count};chrome.storage.local.set({pausedCampaign:pausedCampaignData})}function getDaySuffix(day){if(day>=11&&day<=13)return"th";switch(day%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}function isWithin24Hours(date,time){let dateTime=new Date(date+"T"+time),now=new Date;return Math.abs(now-dateTime)/36e5<24}function hasLeadingOrTrailingSpaces(inputString){return/^\s+|\s+$/g.test(inputString)}function triggerEscape(){var event=new KeyboardEvent("keydown",{key:"Escape",code:"Escape",keyCode:27,charCode:27});document.dispatchEvent(event)}function transposeArray(arr){const numRows=arr[0].length,numCols=arr.length,transposedArray=[];for(let i=0;i<numRows;i++){const newRow=[];for(let j=0;j<numCols;j++)newRow.push(arr[j][i]);transposedArray.push(newRow)}return transposedArray}