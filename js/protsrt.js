let translate_icon_1=chrome.runtime.getURL("logo/pro-translation_1.png"),translate_icon_2=chrome.runtime.getURL("logo/pro-translation_2.png"),is_translate_enabled=!1,is_translate_message_used=!1,is_translate_btn_clicked=!1,languageNames=new Intl.DisplayNames(["en"],{type:"language"}),currentLanguage="en",last_day_since_translate_used="",count_of_days_translate_used=0;function replace_HTML_tags(original_message){let text=original_message;Object.keys(REPLACEMENT_HTML_TAGS).forEach(key=>{let tag=REPLACEMENT_HTML_TAGS[key];text=text.replaceAll(tag.replacement_regex,tag.replacement_pattern)});let tempElement=document.createElement("div");return tempElement.innerHTML=text,text=tempElement.innerText,text}function replace_back_HTML_tags(translated_text,original_message){let text=translated_text;return Object.keys(REPLACEMENT_HTML_TAGS).forEach(key=>{let tag=REPLACEMENT_HTML_TAGS[key];if(tag.replaceback_regex)text=text.replaceAll(tag.replaceback_regex,tag.replaceback_pattern);else{let original_tags=original_message.match(tag.replacement_regex);original_tags&&original_tags.forEach(original_tag=>text=text.replace(tag.replacement_pattern,original_tag)),text=text.replaceAll(tag.replacement_pattern,"")}}),text}function is_valid_translation(detected_language,targeted_language,original_text,translated_text){if(!detected_language||!translated_text)return!1;if(detected_language===targeted_language||original_text==translated_text)return!1;return original_text.replace(/[^a-zA-Z]/g,"").toLowerCase()!==translated_text.replace(/[^a-zA-Z]/g,"").toLowerCase()}async function translate_message_HTML(original_message,targeted_language){if(null==original_message||0===original_message.trim().length)return"";let original_text=replace_HTML_tags(original_message);const translateAPI=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targeted_language}&dt=t&q=${encodeURI(original_text)}`;return await new Promise(resolve=>{try{$.getJSON(translateAPI,function(data){let detected_language=data[2],translated_text=data[0].map(row=>row[0]).join(" ");if(is_valid_translation(detected_language,targeted_language,original_text,translated_text)){let translated_message=replace_back_HTML_tags(translated_text,original_message);resolve([detected_language,translated_message])}else resolve([null,null])})}catch(err){resolve([null,null])}})}function is_in_viewport(childElement,parentElement){if(!childElement||!parentElement)return!1;const childRect=childElement.getBoundingClientRect(),parentRect=parentElement.getBoundingClientRect();return childRect.bottom>=parentRect.top&&childRect.top<=parentRect.bottom}function get_detected_language_names(detected_languages_set){let size=detected_languages_set.size;return 1===size?[...detected_languages_set][0]:2===size?[...detected_languages_set].sort().join(", "):"Multiple Languages"}function add_traslate_button(){let translate_div=document.createElement("div");translate_div.id="translate_div",translate_div.className="hide",translate_div.innerHTML=`\n        <div id="translate_message_btn" class="btn" style="display: ${is_translate_enabled?"none":"flex"}; text-transform:none;">\n            <img src="${translate_icon_1}" class="translate_icon" width="17px"/>\n            <div><span id="detected_language_names"></span> > <span id="targeted_language_name"></span></div>\n            <span class="highlight" style="text-transform:none;">Translate using Pro Sender</span>\n        </div>\n        <div id="original_message_btn" class="btn" style="display: ${is_translate_enabled?"flex":"none"}">\n            <img src="${translate_icon_2}" class="translate_icon" width="17px"/>\n            <span class="highlight">View Original</span>\n        </div>`,getDocumentElement("conversation_panel_wrapper").prepend(translate_div),translate_div.addEventListener("click",translate_all_messages)}function update_translate_button(){let targeted_language="default"===currentLanguage?"en":currentLanguage;document.getElementById("translate_div")||add_traslate_button();let translate_div=document.getElementById("translate_div"),conversation_panel=getDocumentElement("conversation_panel"),all_messages_div=document.querySelectorAll(".message-in"),visible_messages_div=Array.from(all_messages_div).filter(message_div=>is_in_viewport(message_div,conversation_panel)),detected_languages_set=new Set;if(visible_messages_div.forEach(message_container=>{if(message_container.querySelector(".detected_language_name")){let detected_language_name=message_container.querySelector(".detected_language_name").innerText;detected_languages_set.add(detected_language_name)}}),0===detected_languages_set.size)return translate_div.classList.add("hide"),void translate_div.classList.remove("show");let detected_language_names=get_detected_language_names(detected_languages_set),targeted_language_name=languageNames.of(targeted_language);translate_div.classList.add("show"),translate_div.classList.remove("hide"),translate_div.querySelector("#detected_language_names").innerText=detected_language_names,translate_div.querySelector("#targeted_language_name").innerText=targeted_language_name,is_translate_message_used||translate_div.classList.contains("shimmer")||(translate_div.classList.add("shimmer"),setTimeout(()=>translate_div.classList.remove("shimmer"),7e3))}function get_message_div(message_container){let message_parent_div=message_container.querySelector(".selectable-text"),spans=message_parent_div.querySelectorAll(":scope > span");if(spans.length>1){let merged_html="";merged_html+=Array.from(spans).map(span=>span.innerHTML).filter(html=>html.trim().length>0).join("\n");let new_span=document.createElement("span");if(new_span.className=spans[0]?.className,new_span.innerHTML=merged_html,!is_translate_btn_clicked)return new_span;message_parent_div.innerHTML="",message_parent_div.appendChild(new_span)}return message_parent_div.querySelector(":scope > span")}function replace_message(message_container){if(!message_container.querySelector(".selectable-text")||!message_container.querySelector(".translated_message"))return;let message_div=get_message_div(message_container),translated_message=message_container.querySelector(".translated_message").innerHTML,original_message=message_container.querySelector(".original_message").innerHTML,targeted_language_code=message_container.querySelector(".targeted_language_code").innerText,detected_language_code=message_container.querySelector(".detected_language_code").innerText;is_translate_enabled?(message_div.innerHTML=translated_message,message_div.setAttribute("dir",RTL_LANGUAGE_CODES.includes(targeted_language_code)?"rtl":"ltr")):is_translate_btn_clicked&&(message_div.innerHTML=original_message,message_div.setAttribute("dir",RTL_LANGUAGE_CODES.includes(detected_language_code)?"rtl":"ltr"))}function translate_all_messages(){is_translate_enabled=!is_translate_enabled,is_translate_btn_clicked=!0,document.querySelectorAll(".message-in").forEach(message_container=>{replace_message(message_container)}),document.getElementById("original_message_btn").style.display=is_translate_enabled?"flex":"none",document.getElementById("translate_message_btn").style.display=is_translate_enabled?"none":"flex";let translate_div=document.getElementById("translate_div");if(is_translate_enabled){let today=(new Date).toDateString();today==last_day_since_translate_used||count_of_days_translate_used>=5?translate_div.classList.remove("shimmer"):(translate_div.classList.add("shimmer"),setTimeout(()=>translate_div.classList.remove("shimmer"),3e3),last_day_since_translate_used=today,count_of_days_translate_used++,chrome.storage.local.set({lastDaySinceTranslateMessageUsed:last_day_since_translate_used,countOfDaysTranslateMessageUsed:count_of_days_translate_used}))}else translate_div.classList.remove("shimmer");is_translate_message_used=!0,chrome.storage.local.set({isTranslateMessageUsed:!0}),trackEvent("translate_message",currentLanguage)}function translate_visible_messages(){let targeted_language="default"===currentLanguage?"en":currentLanguage,visible_messages_div=document.querySelectorAll(".message-in");visible_messages_div.forEach(async(message_container,index)=>{if(!message_container.querySelector(".translated_message_div")&&message_container.querySelector(".selectable-text")){let translated_message_div=document.createElement("div");translated_message_div.className="translated_message_div",translated_message_div.hidden=!0,message_container.appendChild(translated_message_div);let message=get_message_div(message_container);if(message&&message.innerText.length>0){let original_message=message.innerHTML,[detected_language,translated_message]=await translate_message_HTML(original_message,targeted_language);detected_language&&translated_message&&(translated_message_div.innerHTML=`\n                        <div class="targeted_language_code">${targeted_language}</div>\n                        <div class="detected_language_code">${detected_language}</div>\n                        <div class="targeted_language_name">${languageNames.of(targeted_language)}</div>\n                        <div class="detected_language_name">${languageNames.of(detected_language)}</div>\n                        <div class="translated_message">${translated_message}</div>\n                        <div class="original_message">${original_message}</div>\n                    `,replace_message(message_container),message_container.addEventListener("click",e=>{let number_id=e.target.dataset.jid||e.target.parentNode.dataset.jid||"";number_id&&number_id.includes("@c.us")&&openNumber(number_id.split("@c.us")[0],"")}))}}index==visible_messages_div.length-1&&update_translate_button()})}function translate_messages(){let conversation_panel=getDocumentElement("conversation_panel");if(!conversation_panel)return;add_traslate_button();let is_scrolling=null;is_translate_btn_clicked=is_translate_enabled;let previous_scroll_pos=conversation_panel.scrollTop;function handleScroll(first_time=!1){let scroll_diff=Math.abs(conversation_panel.scrollTop-previous_scroll_pos);(first_time||scroll_diff>33)&&(previous_scroll_pos=conversation_panel.scrollTop,translate_visible_messages()),window.clearTimeout(is_scrolling);let today_yesterday_div=getDocumentElement("today_yesterday_div"),translate_div=document.getElementById("translate_div");translate_div&&(today_yesterday_div?(translate_div.style.top="35px",is_scrolling=setTimeout(()=>translate_div.style.top="0px",3200)):translate_div.style.top="0px")}conversation_panel.addEventListener("scroll",handleScroll),handleScroll(!0)}async function translate(text,sourceLanguage="en",targetLanguage=currentLanguage){return null==text||0===text.trim().length?"":new Promise(resolve=>{chrome.storage.local.get(["translatedCache"],async function(result){const cache=result.translatedCache||{};if(cache[text]&&cache[text][targetLanguage])resolve(cache[text][targetLanguage]);else{const translatedText=await translateAPI(text,sourceLanguage,targetLanguage);cache[text]||(cache[text]={}),cache[text][targetLanguage]=translatedText,chrome.storage.local.set({translatedCache:cache},function(){resolve(translatedText)})}})})}async function translateAPI(text,sourceLanguage="en",targetLanguage=currentLanguage){let filter=normalText=>normalText.replaceAll(/<<(.*?)>>/gi,'<span class="styled_text">$1</span>');if(null==text||0===text.trim().length)return"";if("default"===targetLanguage||targetLanguage===sourceLanguage)return filter(text);const translateAPI=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLanguage}&tl=${targetLanguage}&dt=t&q=${encodeURI(text)}`;return await new Promise(resolve=>{try{$.getJSON(translateAPI,function(data){let translatedText=data[0].map(row=>row[0]).join(" ");resolve(filter(translatedText))})}catch(err){resolve(filter(text))}})}!function initVars(){chrome.storage.local.get(["currentLanguage","isTranslateMessageUsed","lastDaySinceTranslateMessageUsed","countOfDaysTranslateMessageUsed"],res=>{currentLanguage=res.currentLanguage||"default",is_translate_message_used=res.isTranslateMessageUsed||!1,last_day_since_translate_used=res.lastDaySinceTranslateMessageUsed||"",count_of_days_translate_used=res.countOfDaysTranslateMessageUsed||0})}(),chrome.runtime.onMessage.addListener((request,sender,sendResponse)=>{"translate_language"===request.type&&(currentLanguage=request.language)});